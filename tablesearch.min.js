/*
Copyright (c) 2015 Cirons @ Philip Andersson
*/

function TableSearch(e,t){this.table=e,this.tbody=this.table.getElementsByTagName("TBODY")[0],this.tableArray=[],this.shownIndexes=null,this.pageCount=0,this.itemCount=0,this.elementArray=[],this.columnCount=[],this.shownItemCount=0,this.paginatedItems=[],this.page=1,this.pagination=null,t||(t=10),this.pageSize=t,this.init()}TableSearch.prototype={init:function(){this.wrapTable(),this.getColumnCount(),this.serializeTable(),this.renderPagination(),this.renderSearchBox(),this.render()},getColumnCount:function(){var e=this.table.getElementsByTagName("THEAD")[0];this.columnCount=e.getElementsByTagName("TH").length},serializeTable:function(){for(var e=[],t=this.tbody.getElementsByTagName("TR"),n=0;n<t.length;n++){this.itemCount++;var i=t[n];this.elementArray.push(i);for(var a=[],s=i.getElementsByTagName("TD"),r=0;r<s.length;r++){var h=s[r],o=h.textContent;""!==o.trim()&&a.push(h.textContent)}e.push(a)}this.emptyTable(),this.tableArray=e},renderSearchBox:function(){var e=document.createElement("input");e.autocomplete="off",e.placeholder="Search...";var t=this;e.onkeyup=function(){t.search(this.value)},this.insertBefore(this.table,e)},noSearchResult:function(){var e=document.createElement("tr"),t=document.createElement("td");t.colSpan=this.columnCount,t.innerHTML="No results matching your search criteria... :(",e.appendChild(t),this.tbody.appendChild(e)},search:function(e){if(this.page=1,""==e.trim())return this.shownIndexes=null,void this.render();for(var t=[],n=0;n<this.itemCount;n++)for(var i=this.tableArray[n],a=0;a<i.length;a++){var s=i[a],r=new RegExp(e,"gi"),h=s.toString().match(r);h&&h.length&&t.push(n)}return console.log(t),t.length?(this.shownIndexes=t,this.shownItemCount=t.length,void this.render()):(this.emptyTable(),void this.noSearchResult())},render:function(){var e=[];if(null==this.shownIndexes)e=this.elementArray;else for(var t=0;t<this.shownItemCount;t++){var n=this.shownIndexes[t],i=this.elementArray[n];e.push(i)}this.sliceToPages(e),e=this.getPage(this.page),this.appendElements(e),this.reloadPagination()},appendElements:function(e){this.emptyTable();for(var t=0;t<e.length;t++)this.tbody.appendChild(e[t])},emptyTable:function(){this.tbody.innerHTML=""},sliceToPages:function(e){for(var t=[],n=this.pageSize,i=0;i<e.length;i+=n)t.push(e.slice(i,i+n));this.pageCount=t.length,this.paginatedItems=t},getPage:function(e){return this.paginatedItems[e-1]},insertAfter:function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},insertBefore:function(e,t){e.parentNode.insertBefore(t,e)},renderPagination:function(){var e=document.createElement("div");e.innerHTML="test",e.className+="ts-pagination",this.insertAfter(this.table,e),this.pagination=e},showPage:function(e){this.page=e;var t=this.getPage(this.page);console.log(this),this.appendElements(t)},reloadPagination:function(){this.pagination.innerHTML="";for(var e=document.createElement("ul"),t=1;t<=this.pageCount;t++){var n=document.createElement("li"),i=document.createElement("a");i.href="javascript:;",i.innerHTML=t.toString(),t==this.page&&(i.className+="ts-page-active");var a=this;i.onclick=function(){a.showPage(parseInt(this.innerHTML))},n.appendChild(i),e.appendChild(n)}this.pagination.appendChild(e)},wrapTable:function(){var e=this.table,t=document.createElement("div");return t.className+="ts-table",e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t),t.appendChild(e)}};